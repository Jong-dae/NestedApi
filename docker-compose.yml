version: '3.8'

# Common envoriment variables used in all service containers.
x-common-variables: &common-variables
  - NESTEDAPI_AMQP_BROKER=message-bus
  - NESTEDAPI_MAX_CONNECTIONS=3
  - RABBITMQ_AMQP_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@message-bus:5672/%2f

services:
  # API Gateway Service
  gateway:
    container_name: gateway
    image: quay.io/datawire/ambassador:0.86.1
    command: --port 8080
    ports:
      - "8080:8080"
    environment:
      - AMBASSADOR_NO_KUBEWATCH=no_kubewatch
    networks:
      - internal-network
    volumes:
      - ./configs/gateway-config.yml:/ambassador/ambassador-config
  
  # Bus Message Service
  message-bus:
    container_name: message-bus
    image: docker.io/library/rabbitmq:alpine
    environments:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD}
    networks:
      - internal-network

  # Specific Module Service - Authorization
  auth-service:
    container_name: auth-service
    build: ./src/Authorization
    environments: # Command for key generating: openssl rand -base64 172 | tr -d '\n'
      - NESTEDAPI_AUTH_KEY=${NESTEDAPI_AUTH_KEY}
      - JDBC_DATABASE_URL=jdbc:postgresql://auth-database/${POSTGRES_DB}?user=${POSTGRES_USER}&password=${POSTGRES_PASSWORD}
      - *common-variables
    deploy:
      replicas: 1
    networks:
      - internal-network

  auth-database:
    container_name: auth-database
    image: docker.io/library/postgres:alpine
    environments:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      - internal-network
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # Specific Module Service - Users
  users-service:
    container_name: users-service
    build: ./src/Users
    environments:
      - JDBC_DATABASE_URL=jdbc:postgresql://users-database/${POSTGRES_DB}?user=${POSTGRES_USER}&password=${POSTGRES_PASSWORD}
      - *common-variables
    deploy:
      replicas: 1
    networks:
      - internal-network

  users-database:
    container_name: users-database
    image: docker.io/library/postgres:alpine
    environments:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      - internal-network
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # Specific Module Service - Payments
  payments-service:
    container_name: payments-service
    build: ./src/Payments
    environments:
      - JDBC_DATABASE_URL=jdbc:postgresql://payments-database/${POSTGRES_DB}?user=${POSTGRES_USER}&password=${POSTGRES_PASSWORD}
      - *common-variables
    deploy:
      replicas: 1
    networks:
      - internal-network

  payments-database:
    container_name: payments-database
    image: docker.io/library/postgres:alpine
    environments:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      - internal-network
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # Specific Module Service - Invoices
  invoices-service:
    container_name: invoices-service
    build: ./src/Invoices
    environments:
      - JDBC_DATABASE_URL=jdbc:postgresql://invoices-database/${POSTGRES_DB}?user=${POSTGRES_USER}&password=${POSTGRES_PASSWORD}
      - *common-variables
    deploy:
      replicas: 1
    networks:
      - internal-network

  invoices-database:
    container_name: invoices-database
    image: docker.io/library/postgres:alpine
    environments:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      - internal-network
    volumes:
      - postgres_data:/var/lib/postgresql/data

networks:
  # Internal Network
  internal-network:
    external: false